<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transfer · Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <link rel="icon" href="bank-swift.svg" type="image/svg+xml" />
  <link rel="shortcut icon" href="bank-swift.svg" />
  <link rel="stylesheet" href="ui.css" />
  <style>
    body { background:#0d0f14; color:#eef3f8; font-family: system-ui, Arial, sans-serif; }
    header { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:1rem 1.25rem; border-bottom:1px solid #1e2530; }
    header h1 { font-size:1.05rem; margin:0; letter-spacing:.5px; }
    a.back-link { color:#7aa8ff; text-decoration:none; font-size:.85rem; }
    a.back-link:hover { text-decoration:underline; }

    main.layout { max-width:980px; margin:1rem auto 2rem; padding:0 1rem; display:grid; gap:1rem; grid-template-columns: 1.15fr .85fr; }
    .panel { background:#141a24; border:1px solid #1f2530; border-radius:14px; padding:1.1rem 1.1rem 1.25rem; }
    .panel h2 { margin:0 0 .85rem; font-size:.9rem; letter-spacing:.5px; text-transform:uppercase; color:#7d8da3; }

    .status-bar { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:.6rem; font-size:.72rem; color:#96a6bd; }
    .pill { background:#1f2733; padding:.35rem .6rem; border-radius:999px; font-size:.62rem; letter-spacing:.4px; }

    .tabs { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:1rem; }
    .tab { cursor:pointer; border:none; border-radius:10px; padding:.55rem .8rem; background:#1d2733; color:#e9eef5; font-size:.78rem; }
    .tab.active { background:#2663ff; color:#fff; }

    .row { display:grid; grid-template-columns: 1fr 1fr; gap:.85rem; }
    .row.full { grid-template-columns: 1fr; }
    .field { display:flex; flex-direction:column; gap:.35rem; }
    .field label { font-size:.75rem; color:#8aa0b9; }
    .field input, .field select, .field textarea {
      background:#0f141d; border:1px solid #202a39; color:#e8eef6; border-radius:8px; padding:.7rem .8rem; font-size:.85rem; outline:none;
    }

    .actions { display:flex; gap:.6rem; flex-wrap:wrap; margin-top:1rem; }
    .btn { cursor:pointer; border:none; border-radius:10px; padding:.75rem 1rem; background:#1d2733; color:#e9eef5; font-size:.82rem; }
    .btn:hover { background:#233040; }
    .btn-primary { background:#2663ff; color:#fff; }
    .btn-primary:hover { background:#1f55dc; }
    .muted { font-size:.75rem; color:#7a889a; }
    .error { color:#ff8a8a; font-size:.78rem; min-height:1.1rem; }

    .summary { background:#121a28; border:1px solid #202a39; border-radius:12px; padding:.85rem; display:grid; gap:.35rem; font-size:.82rem; }
    .summary .rowline { display:flex; justify-content:space-between; gap:.75rem; }

    /* Success Modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:40; }
    .modal .card { background:#0f141d; border:1px solid #223048; border-radius:14px; width:min(480px,92vw); padding:1rem 1rem 1.15rem; }
    .modal h3 { margin:0 0 .35rem; font-size:1rem; }
    .modal .ok { display:flex; align-items:center; gap:.5rem; color:#91f2b4; font-size:.9rem; margin-bottom:.5rem; }
    .kvs { background:#101826; border:1px solid #223048; border-radius:10px; padding:.75rem; display:grid; gap:.45rem; margin:.6rem 0 .8rem; font-size:.85rem; }
    .kv { display:flex; justify-content:space-between; gap:.75rem; }
    .modal .actions { justify-content:flex-end; }

    @media (max-width:880px){ main.layout { grid-template-columns: 1fr; } }
    @media (max-width:520px){
      header { flex-direction:column; align-items:flex-start; }
      .row { grid-template-columns: 1fr; }
      .btn { flex:1; justify-content:center; }
    }
    .btn.loading{ opacity:.7; cursor:progress; pointer-events:none; }
    .btn .spinner{ display:none; width:16px; height:16px; border:2px solid rgba(255,255,255,.55); border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite; margin-right:8px; }
    .btn.loading .spinner{ display:inline-block; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
  </style>
</head>
<body>
  <header>
    <h1>Transfer</h1>
    <nav>
  <a class="back-link" href="dashboard.html">← Back to Home</a>
    </nav>
  </header>

  <main class="layout">
    <!-- Left: Transfer form -->
    <section class="panel">
      <h2>New Transfer</h2>

      <div class="status-bar">
        <span class="pill" id="userPill">Loading…</span>
        <span class="pill" id="balPill">Available — …</span>
      </div>

      <div class="tabs" role="tablist" aria-label="Transfer method">
        <button class="tab active" data-method="wire" aria-selected="true">Wire</button>
        <button class="tab" data-method="eft">EFT</button>
        <button class="tab" data-method="ach">ACH</button>
        <button class="tab" data-method="btc">BTC</button>
      </div>

      <form id="transferForm" novalidate>
        <div class="row">
          <div class="field">
            <label for="fromAccount">From account</label>
            <select id="fromAccount" name="sender_account_type">
              <option value="checking">Checking</option>
              <option value="savings">Savings</option>
            </select>
          </div>
          <!-- Removed recipient account option per request -->
        </div>

        <div class="row">
          <div class="field">
            <label for="recipientName">Recipient name</label>
            <input id="recipientName" name="recipientName" type="text" placeholder="Full or account name" required />
          </div>
          <div class="field">
            <label for="recipientEmail">Recipient email</label>
            <input id="recipientEmail" name="recipient_email" type="email" placeholder="name@example.com" required />
          </div>
        </div>

        <!-- Bank details (shown for wire/eft/ach) -->
        <div id="bankDetails" class="row">
          <div class="field">
            <label for="bankName">Bank name</label>
            <input id="bankName" name="bank_name" type="text" placeholder="Bank" />
          </div>
          <div class="field">
            <label for="routingNumber">Routing number</label>
            <input id="routingNumber" name="routing_number" type="text" placeholder="Routing" />
          </div>
          <div class="field">
            <label for="accountNumber">Account number</label>
            <input id="accountNumber" name="account_number" type="text" placeholder="Account" />
          </div>
          <div class="field">
            <label for="note">Description (optional)</label>
            <input id="note" name="description" type="text" placeholder="Add a note" />
          </div>
        </div>

        <!-- BTC details (shown for btc) -->
        <div id="btcDetails" class="row" style="display:none;">
          <div class="field">
            <label for="btcAddress">BTC address</label>
            <input id="btcAddress" name="btc_address" type="text" placeholder="bc1..." />
          </div>
          <div class="field">
            <label for="noteBtc">Description (optional)</label>
            <input id="noteBtc" name="description_btc" type="text" placeholder="Add a note" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="amount">Amount</label>
            <input id="amount" name="amount" type="number" min="1" step="0.01" placeholder="0.00" required />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div class="summary">
              <div class="rowline"><span>Method</span><strong id="sumMethod">Wire</strong></div>
              <div class="rowline"><span>Total</span><strong id="sumTotal">$0.00</strong></div>
            </div>
          </div>
        </div>

        <div id="formError" class="error"></div>
        <div class="actions">
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span class="spinner" aria-hidden="true"></span>
            <span class="label">Submit Transfer</span>
          </button>
          <button type="button" class="btn" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </section>

    <!-- Right: Tips / Info -->
    <aside class="panel">
      <h2>Transfer Info</h2>
      <p class="muted">Send money securely using Wire, EFT, ACH, or convert and send BTC.</p>
      <ul class="muted" style="margin:.6rem 0 0 1rem;">
        <li>Recipient name and email are required.</li>
        <li>Wire/EFT/ACH require bank details; BTC requires a wallet address.</li>
        <li>Your available balance updates automatically.</li>
      </ul>
    </aside>
  </main>

  <!-- Success Modal -->
  <div id="successModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="successTitle">
    <div class="card">
      <div class="ok">✅ <strong id="successTitle">Transfer Processing</strong></div>
      <div class="kvs" id="successDetails"></div>
      <div class="actions">
        <button class="btn" id="closeModalBtn">Close</button>
        <button class="btn btn-primary" id="viewReceiptBtn">View Receipt</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="common.js"></script>
  <script>
    let user = null;
    let currentMethod = 'wire';
    let feeRate = 0.235;

    const qs = (s)=>document.querySelector(s);
    const qsa = (s)=>Array.from(document.querySelectorAll(s));

    function fmtAmt(n){ return isFinite(n) ? Number(n).toLocaleString(undefined,{style:'currency',currency:'USD'}) : '$0.00'; }
    function setText(id, val){ const el = document.getElementById(id); if(el) el.textContent = val; }

    function loadStoredUser(){
      try { user = JSON.parse(localStorage.getItem('bs-user')||'null'); } catch { user = null; }
      if(!user || !user.token){ location.href='login.html'; return; }
      setText('userPill', user.fullname || user.accountname || '—');
      updateBalancePillFromAccounts(user?.balances?.accounts || user?.accounts);
    }

    async function loadFeeRate(){
      try {
        const res = await fetch(API_BASE + '/settings');
        const data = await res.json();
        if (res.ok && data?.feeRate != null) {
          const rate = Number(data.feeRate);
          if (Number.isFinite(rate)) feeRate = rate;
        }
      } catch {}
    }
    function updateBalancePillFromAccounts(accounts){
      if (!Array.isArray(accounts)) {
        setText('balPill', 'Available — $0.00');
        return;
      }

      const avail = accounts.reduce(
        (sum, a) => sum + Number(a.available || 0),
        0
      );

      setText('balPill', 'Available — ' + fmtAmt(avail));
    }

    function selectMethod(m){
      currentMethod = m;
      qsa('.tab').forEach(t => t.classList.toggle('active', t.dataset.method === m));
      setText('sumMethod', m.toUpperCase());
      // Toggle detail blocks
      const bank = qs('#bankDetails'), btc = qs('#btcDetails');
      if(m === 'btc'){ bank.style.display='none'; btc.style.display='grid'; }
      else { bank.style.display='grid'; btc.style.display='none'; }
    }

    function authHeaders(){
      return { 'Content-Type':'application/json', 'Authorization':'Bearer '+ (user?.token || '') };
    }

    async function refreshProfile(){
      try {
        const res = await fetch(API_BASE + '/api/users/me', {
          headers: authHeaders()
        });
        if (!res.ok) return;

        const profile = await res.json();

        // Backend returns balances.accounts (not profile.accounts)
        user = { ...user, ...profile };
        localStorage.setItem('bs-user', JSON.stringify(user));

        const accounts = profile?.balances?.accounts || profile?.accounts || [];
        updateBalancePillFromAccounts(accounts);
      } catch (e) {
        console.warn('Profile refresh failed', e);
      }
    }

    function setSubmitting(isSubmitting){
      const btn = document.getElementById('submitBtn');
      if (!btn) return;
      btn.classList.toggle('loading', isSubmitting);
      btn.setAttribute('aria-busy', String(isSubmitting));
      btn.querySelector('.label').textContent = isSubmitting ? 'Processing…' : 'Submit Transfer';
    }

    async function handleSubmit(e){
      e.preventDefault();
      qs('#formError').textContent = '';

      const form = e.currentTarget;
      const fd = new FormData(form);
      const payload = {
        sender_email: user.email,
        amount: parseFloat(fd.get('amount')||'0'),
        recipient_name: (fd.get('recipientName')||'').trim() || null,
        recipient_email: (fd.get('recipient_email')||'').trim() || null,
        sender_account_type: fd.get('sender_account_type') || 'checking',
        recipient_account_type: 'checking',
        bank_name: fd.get('bank_name') || null,
        routing_number: fd.get('routing_number') || null,
        account_number: fd.get('account_number') || null,
        btc_address: fd.get('btc_address') || null,
        description: (fd.get('description') || fd.get('description_btc') || '').trim() || null,
        method: currentMethod // 'wire' | 'eft' | 'ach' | 'btc'
      };

      // Validate amount
      if(!payload.amount || payload.amount <= 0){
        qs('#formError').textContent = 'Enter a valid amount.';
        return;
      }

      // Ensure there is a recipient identifier: email (possibly external) OR bank details OR BTC address OR name (for internal lookup)
      const hasRecipientEmail = !!payload.recipient_email;
      const hasBankDetails = !!(payload.account_number && payload.routing_number && payload.bank_name);
      const hasBtc = !!payload.btc_address;
      const hasName = !!payload.recipient_name;

      if (!hasRecipientEmail) {
        qs('#formError').textContent = 'Recipient email is required.';
        return;
      }

      // For bank transfers require bank fields when method is wire/eft/ach
      if ((currentMethod === 'wire' || currentMethod === 'eft' || currentMethod === 'ach') && !hasBankDetails && !hasRecipientEmail && !hasName) {
        qs('#formError').textContent = 'Bank name, account number and routing number are required for bank transfers unless recipient email or name is provided.';
        return;
      }

      // For BTC require btc address
      if (currentMethod === 'btc' && !hasBtc) {
        qs('#formError').textContent = 'BTC address is required for BTC transfers.';
        return;
      }

      try {
        setSubmitting(true);
        const res = await fetch(API_BASE + '/transfers', { method:'POST', headers: authHeaders(), body: JSON.stringify(payload) });
        const tx = await res.json().catch(()=> ({}));
        if(!res.ok) throw new Error(tx?.error || ('Transfer failed ('+res.status+')'));

        // Success modal
        const recipientDisplay = payload.recipient_name || '—';
        const feeAmount = payload.amount * feeRate;
        document.getElementById('successDetails').innerHTML = `
          <div class="kv"><span>Recipient</span><strong>${recipientDisplay}</strong></div>
          <div class="kv"><span>Amount</span><strong>${fmtAmt(payload.amount)}</strong></div>
          <div class="kv"><span>Fee</span><strong>${fmtAmt(feeAmount)}</strong></div>
          <div class="kv"><span>Method</span><strong>${currentMethod.toUpperCase()}</strong></div>
          <div class="kv"><span>Status</span><strong>PENDING</strong></div>
        `;
        document.getElementById('successModal').style.display = 'flex';

        // Store for receipt page
        localStorage.setItem('last-transfer', JSON.stringify(tx && tx.id ? tx : {
          id: tx.id || ('TX-'+Date.now()),
          amount: payload.amount,
          type: tx.type || (currentMethod === 'btc' ? 'debit' : 'debit'),
          description: payload.description || null,
          sender_email: user.email,
          recipient_email: tx.recipient_email || payload.recipient_email || null,
          sender_fullname: user.fullname || user.accountname || null,
          recipient_fullname: tx.recipient_fullname || payload.recipient_name || null,
          sender_account_name: tx.sender_account_name || user.accountname || null,
          recipient_account_name: tx.recipient_account_name || payload.recipient_name || null,
          status: 'pending',
          created_at: tx.created_at || new Date().toISOString()
        }));

        form.reset();
        updateSummaryTotal(0);
      } catch (err){
        qs('#formError').textContent = err.message || 'Transfer failed';
      } finally {
        setSubmitting(false);
      }
    }

    function updateSummaryTotal(val){
      setText('sumTotal', fmtAmt(val));
    }

    function bindUI(){
      qsa('.tab').forEach(btn => btn.addEventListener('click', ()=> selectMethod(btn.dataset.method)));
      qs('#transferForm').addEventListener('submit', handleSubmit);
  qs('#cancelBtn').addEventListener('click', ()=> location.href='dashboard.html');
      qs('#amount').addEventListener('input', (e)=> updateSummaryTotal(parseFloat(e.target.value||'0')));
      document.getElementById('closeModalBtn').addEventListener('click', ()=> document.getElementById('successModal').style.display='none');
      document.getElementById('viewReceiptBtn').addEventListener('click', ()=> location.href='transactions.html');
    }

    function connectSSE(){
      if(!user?.id || !user?.token) return;
      try {
        const sse = new EventSource(API_BASE.replace(/\/api$/,'') + `/api/stream/user/${user.id}?token=${user.token}`);
        sse.onmessage = (e)=>{
          try {
            const profile = JSON.parse(e.data);
            if(profile && profile.id){
              // Update balance pill and mirror
              const accounts = profile?.balances?.accounts || profile?.accounts;
              if (accounts) updateBalancePillFromAccounts(accounts);
              user = { ...user, ...profile };
              localStorage.setItem('bs-user', JSON.stringify(user));
            }
          } catch {}
        };
        sse.onerror = ()=> sse.close();
      } catch {}
    }

    // Init
    (async function init(){
      if (window.Notifications) window.Notifications.init();
      loadStoredUser();
      await loadFeeRate();
      await refreshProfile();
      bindUI();
      selectMethod('wire');
      connectSSE();
    })();
  </script>
</body>
</html>
